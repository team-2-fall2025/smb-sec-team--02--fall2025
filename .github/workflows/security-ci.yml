name: Security (SAST + SCA)

on:
  pull_request:
  push:
    branches: [ main, week7backend ]

permissions:
  contents: read

jobs:
  security:
    runs-on: ubuntu-latest
    env:
      REPORT_DIR: docs/reports/audit

    steps:
      - uses: actions/checkout@v4

      - name: Prepare report dir
        run: mkdir -p "${REPORT_DIR}"

      # -------------------------
      # Python: Bandit (SAST)
      # -------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Bandit + pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install bandit pip-audit

      - name: Bandit (fail on HIGH)
        run: |
          bandit -r src/backend -ll -iii -q \
            -x "src/backend/.venv,src/backend/**/tests" \
            -f json -o "${REPORT_DIR}/bandit.json"
          bandit -r src/backend -ll -iii -q \
            -x "src/backend/.venv,src/backend/**/tests" \
            -f txt -o "${REPORT_DIR}/bandit.txt"

      # -------------------------
      # Python deps: pip-audit (SCA)
      # -------------------------
      - name: pip-audit (requirements.txt)
        run: |
          pip-audit -r src/backend/requirements.txt \
            --format json --output "${REPORT_DIR}/pip-audit.json"

      # -------------------------
      # Node: npm audit (SCA)
      # -------------------------
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: src/frontend/package-lock.json

      - name: Install frontend deps
        working-directory: src/frontend
        run: npm ci

      - name: npm audit (fail on HIGH)
        working-directory: src/frontend
        run: |
          npm audit --json > "../../${REPORT_DIR}/npm-audit.json" || true
          npm audit --audit-level=high

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: docs/reports/audit
